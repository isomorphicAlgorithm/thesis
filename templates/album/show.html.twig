{% extends 'base.html.twig' %}

{% block title %} {{ album.title }} | Bandito {% endblock %}

{% block body %}
<div class="max-w-6xl mx-auto mt-12 text-yellow-50 space-y-10 px-4">
    <!-- Cards Row -->
    <div class="flex flex-col lg:flex-row gap-6">

        <!-- Album Info Card -->
        <div class="w-full lg:w-4/6 bg-black/70 p-7 rounded-xl border-2 border-yellow-500/60 flex flex-col gap-7 min-w-0">

            <!-- Album Cover -->
            <img src="{% if file_exists_in_public('uploads/albums/' ~ album.coverImage) %}{{ asset('uploads/albums/' ~ album.coverImage) }}{% else %}{{ album.coverImage }}{% endif %}"
                 alt="{{ album.title }}"
                 class="w-full h-auto max-h-72 object-cover rounded-xl shadow-xl border-2 border-yellow-500/60 mx-auto">

            <!-- Album Title -->
            <h1 class="text-5xl font-extrabold leading-tight break-words">{{ album.title }}</h1>

            <!-- Bands -->
            <div class="flex flex-wrap items-center gap-3">
                {% for band in album.bands %}
                    <a href="{{ path('band_show', {id: band.id, slug: band.slug}) }}"
                       class="text-yellow-300 hover:underline font-semibold flex items-center gap-2">
                        <img src="{% if file_exists_in_public('uploads/bands/' ~ band.coverImage) %}{{ asset('uploads/bands/' ~ band.coverImage) }}{% else %}{{ band.coverImage }}{% endif %}"
                             alt="{{ band.name }}"
                             class="w-14 h-14 rounded-full border-2 border-yellow-500/60 hover:custom-glow">
                        <span>{{ band.name }}</span>
                    </a>
                {% endfor %}
            </div>

            <!-- Truncated Description -->
            <div class="text-yellow-300 text-base break-words leading-relaxed">
                {% set full = album.description|striptags %}
                {% set words = full|split(' ') %}
                {% set short = words|slice(0, 40)|join(' ') %}
                <p class="text-yellow-50">{{ short }}{% if words|length > 40 %}... <a href="{{ album.lastfmLink|default('#') }}" class="text-blue-400 hover:underline">Read more on Last.fm</a>{% endif %}</p>
            </div>

            <!-- Metadata -->
            <div class="text-yellow-300 font-bold text-m space-y-1">
                <p>Released: <span class="text-base font-normal leading-relaxed text-yellow-50">{{ album.releaseDate|date('F Y') }}</span></p>
                <p>Genres: <span class="text-base font-normal leading-relaxed text-yellow-50">
                    {% if album.genres|length > 0 %}
                        {% for genre in album.genres %}
                            {{ genre.displayName }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    {% else %}-{% endif %}
                </span></p>
                <p>Duration: <span class="text-base font-normal leading-relaxed text-yellow-50">{{ album.duration|duration_format }}</span></p>
            </div>
        </div>

        <!-- Rating + Links Combined Card -->
        <div class="w-full lg:w-2/6 bg-black/70 p-7 rounded-xl border-2 border-yellow-500/60 flex flex-col items-center justify-start gap-7 min-w-0">

            <!-- Average Rating -->
            {% set averageScore = album.averageRating|default('N/A') %}
            {% set averageScoreColor = 'bg-red-500' %}
            {% if averageScore == 'N/A' %}
                {% set averageScoreColor = 'bg-yellow-50' %}
            {% elseif averageScore >= 75 %}
                {% set averageScoreColor = 'bg-green-500' %}
            {% elseif averageScore >= 50 %}
                {% set averageScoreColor = 'bg-yellow-400' %}
            {% endif %}

            <div class="flex flex-col items-center text-center space-y-2">
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-black/70 {{ averageScoreColor }}">
                    {{ averageScore }}
                </div>
                <span class="text-sm text-yellow-500/60">Average Rating (out of 100)</span>
            </div>

            {% set userScore = userRating|default('N/A') %}
            {% set userScoreColor = 'bg-red-500' %}
            {% if userScore == 'N/A' %}
                {% set userScoreColor = 'bg-yellow-50' %}
            {% elseif userScore >= 75 %}
                {% set userScoreColor = 'bg-green-500' %}
            {% elseif userScore >= 50 %}
                {% set userScoreColor = 'bg-yellow-400' %}
            {% endif %}

            <!-- User Rating -->
            {% if app.user %}
                <div class="flex flex-col items-center text-center space-y-2">
                    <span class="text-xl font-bold text-yellow-500">Your Rating:</span>
                    <div class="w-20 h-20 rounded-full flex items-center justify-center font-bold text-black/70 {{ userScoreColor }}">
                        {{ userScore }}
                    </div>
                </div>

                <div class="text-center">
                    <p class="text-yellow-500 text-xl font-semibold mb-3">Rate this album</p>
                    <form action="{{ path('album_show', {id: album.id, slug: album.slug}) }}" method="post" id="ratingForm">
                        <input type="hidden" name="rating" id="ratingInput" value="{{ userRating|default(50) }}">
                        <div id="rating-slider" data-initial-rating="{{ userRating|default(50) }}">
                            <svg viewBox="0 0 100 100" class="mx-auto w-17 h-17">
                                <circle class="slider-bg" cx="50" cy="50" r="45" />
                                <path id="arc" class="slider-arc" />
                                <circle id="knob" class="slider-knob" cx="50" cy="5" r="6" />
                            </svg>
                            <div id="rating-value" class="mt-1 text-sm font-semibold text-yellow-100">50</div>
                        </div>
                        <button type="submit" class="mt-2 bg-yellow-400 text-black px-4 py-2 rounded hover:bg-yellow-300 font-semibold cursor-pointer">Rate</button>
                    </form>
                </div>

                {% if userRating and existingRating %}
                    <form action="{{ path('album_delete_score', {albumId: album.id, id: existingRating.id}) }}" method="post" onsubmit="return confirm('Delete your rating?');" class="inline-block mt-2">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete-rating-score' ~ existingRating.id) }}">
                        <button type="submit"
                                class="bg-red-600 hover:custom-glow text-white px-2 py-2 rounded text-sm font-semibold cursor-pointer"
                                title="Delete your rating score">
                            Delete Rating
                        </button>
                    </form>
                {% endif %}

            {% endif %}

            <!-- Links Section -->
            {% if album.links %}
                <div class="w-full">
                    <h2 class="text-lg font-semibold text-yellow-500 mb-2 text-center flex items-center gap-2 justify-center">
                        Links
                    </h2>
                    <div class="flex flex-wrap justify-center gap-3">
                        {% include 'partials/_social_links.html.twig' with { links: album.links } %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Tracklist -->
    <div class="bg-black/70 p-6 rounded-xl border-2 border-yellow-500/60 shadow-md">
        <h2 class="text-xl font-bold flex items-center text-yellow-300 gap-3 mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="currentColor" stroke-width="2" class="size-6 text-yellow-400">
                <path fill-rule="evenodd" d="M19.952 1.651a.75.75 0 0 1 .298.599V16.303a3 3 0 0 1-2.176 2.884l-1.32.377a2.553 2.553 0 1 1-1.403-4.909l2.311-.66a1.5 1.5 0 0 0 1.088-1.442V6.994l-9 2.572v9.737a3 3 0 0 1-2.176 2.884l-1.32.377a2.553 2.553 0 1 1-1.402-4.909l2.31-.66a1.5 1.5 0 0 0 1.088-1.442V5.25a.75.75 0 0 1 .544-.721l10.5-3a.75.75 0 0 1 .658.122Z" clip-rule="evenodd"/>
            </svg>
            Tracklist
        <h2>

        {% if album.songs|length > 0 %}
            <ul class="space-y-2">
                {% for song in album.songs %}
                    <li class="flex justify-between items-center bg-zinc-800 p-3 rounded hover:bg-zinc-700 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-yellow-400 font-mono">{{ loop.index }}.</span>
                            <a href="{{ path('song_show', {id: song.id, slug: song.slug}) }}"
                                class="font-semibold"
                            >
                                <span class="text-white hover:text-yellow-300 transition">{{ song.title }}</span>
                            </a>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-yellow-50">
                            {% if song.duration %}
                                <span>{{ song.duration|duration_format }}</span>
                            {% endif %}
                            <i class="fas fa-play hover:text-yellow-400 cursor-pointer"></i>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-yellow-50">No tracks available for this album.</p>
        {% endif %}
    </div>

    <!-- Reviews -->
    <div class="bg-black/70 p-6 rounded-xl border-2 border-yellow-500/60 shadow-md">
        <h2 class="text-xl font-bold flex items-center text-yellow-300 gap-3 mb-6">
            <svg class="size-6 text-yellow-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 5v14h14V5H5zm2 4h10M7 12h6"/>
            </svg>
            Reviews
        </h2>

        {% if app.user %}
            <form action="{{ path('album_show', { id: album.id, slug: album.slug }) }}" method="post" class="mb-4 review-form">
                <label for="review" class="block text-yellow-500/60 font-semibold mb-1">
                    {{ userReview ? 'Edit your review' : 'Write your review (min 600 characters)' }}
                </label>

                <textarea id="review" name="review" rows="5"
                        class="w-full p-3 bg-yellow-50 text-black/70 rounded text-sm"
                        placeholder="Write your review here...">{{ userReview ?? '' }}</textarea>

                <div class="mt-2">
                    <div class="relative h-2 rounded bg-yellow-100/30 overflow-hidden">
                        <div id="review-progress" class="h-full bg-yellow-400 transition-all duration-200 ease-in-out" style="width: 0%"></div>
                    </div>
                    <div id="review-counter" class="text-xs mt-1 text-yellow-100">0/600 characters</div>
                </div>

                <div class="flex items-center mt-3">
                    <button type="submit"
                            class="bg-yellow-400 text-black px-4 py-2 rounded hover:bg-yellow-300 text-sm font-semibold cursor-pointer">
                        {{ userReview ? 'Update Review' : 'Post Review' }}
                    </button>

                    {% if userReview and existingRating %}
                    {% set redirectUrl = filters is defined ? path('reviews_list', filters) : path('album_show', {id: album.id, slug: album.slug}) %}

                        <button
                            type="button"
                            data-album-id="{{ album.id }}"
                            data-rating-id="{{ existingRating.id }}"
                            data-csrf-token="{{ csrf_token('delete-rating-review' ~ existingRating.id) }}"
                            class="delete-review-btn ml-auto bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded text-sm font-semibold cursor-pointer"
                            title="Delete your review"
                            data-redirect-url="{{ redirectUrl }}"
                        >
                            Delete Review
                        </button>
                    {% endif %}
                </div>
            </form>
        {% endif %}

        <!-- Horizontally scrollable reviews -->
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg text-yellow-300 font-semibold">What others are saying</h3>
            {% if additionalReviewCount > 0 %}
                <div class="flex items-center gap-2">
                    <a href="{{ path('reviews_list', {album: album.id}) }}"
                        class="bg-yellow-400 hover:bg-yellow-300 text-sm font-semibold text-black py-2 px-4 rounded transition hover:custom-glow">
                        Show all reviews
                    </a>
                    <span class="text-sm text-yellow-300 bg-yellow-600/10 px-3 py-1 rounded-full border border-yellow-500">
                        +{{ additionalReviewCount }} more
                    </span>
                </div>
            {% else %}
                <div class="flex items-center gap-2">
                    <a href="{{ path('reviews_list', {album: album.id}) }}"
                        class="bg-yellow-400 hover:bg-yellow-300 text-sm font-semibold text-black py-2 px-4 rounded transition hover:custom-glow">
                        Show all reviews
                    </a>
                </div>
            {% endif %}
        </div>

        {% if visibleReviews is not empty %}
            <div class="relative">
                <!-- Scrollable Container -->
                <div class="overflow-x-auto no-scrollbar flex space-x-4 pb-2" id="review-carousel">
                    {% for rating in visibleReviews %}
                        {% if rating.review is not empty %}
                            <div class="min-w-[250px] max-w-sm bg-zinc-800/70 p-4 rounded-lg border border-yellow-400/40 text-yellow-50 shadow-md shrink-0 relative">
                                <!-- Make container relative -->

                                <div class="font-semibold text-yellow-200 text-sm mb-1">{{ rating.user.username }}</div>

                                {% if rating.ratingScore is not null %}
                                    <div class="text-xs text-yellow-300 mb-1">Rated: {{ rating.ratingScore }}/100</div>
                                {% endif %}

                                <div class="text-xs text-yellow-100 mb-1">{{ rating.createdAt|date('M d, Y') }}</div>
                                <div class="text-sm break-words">{{ rating.review|u.truncate(300, '...') }}</div>

                                {% if app.user and (app.user.id == rating.user.id or is_granted('ROLE_ADMIN')) %}
                                {% set redirectUrl = filters is defined ? path('reviews_list', filters) : path('album_show', {id: album.id, slug: album.slug}) %}

                                    <button
                                        type="button"
                                        data-album-id="{{ album.id }}"
                                        data-rating-id="{{ rating.id }}"
                                        data-csrf-token="{{ csrf_token('delete-rating-review' ~ rating.id) }}"
                                        data-redirect-url="{{ redirectUrl }}"
                                        class="no-glow delete-review-btn absolute top-2 right-2 text-red-500 hover:text-red-400 rounded-xl px-1 py-1 cursor-pointer"
                                        title="Delete review" aria-label="Delete Review">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Arrows -->
                <button id="scroll-left"
                        class="arrow-btn left-0 hidden cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>

                <button id="scroll-right"
                        class="arrow-btn right-0 hidden cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        {% else %}
            <p class="text-yellow-50">No reviews yet.</p>
        {% endif %}
    </div>

</div>
{% endblock %}