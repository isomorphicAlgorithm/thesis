{% extends 'base.html.twig' %}

{% block title %}Reviews {% if album %} for - {{ album.title }}{% endif %}{% endblock %}

{% block body %}
<div class="max-w-6xl mx-auto mt-6 flex gap-6">

    <!-- Filter Sidebar -->
    <aside class="w-50 bg-black/70 rounded-2xl border border-yellow-500/60 p-4 shadow-md flex-shrink-0 self-start">
        <form method="get" class="space-y-3">
            <h2 class="text-lg font-bold text-yellow-50 flex items-center mb-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="h-5 w-5 text-yellow-400 mr-2" viewBox="0 0 24 24">
                    <path fill-rule="evenodd" d="M2.25 4.5A.75.75 0 0 1 3 3.75h14.25a.75.75 0 0 1 0 1.5H3a.75.75 0 0 1-.75-.75Zm0 4.5A.75.75 0 0 1 3 8.25h9.75a.75.75 0 0 1 0 1.5H3A.75.75 0 0 1 2.25 9Zm15-.75A.75.75 0 0 1 18 9v10.19l2.47-2.47a.75.75 0 1 1 1.06 1.06l-3.75 3.75a.75.75 0 0 1-1.06 0l-3.75-3.75a.75.75 0 1 1 1.06-1.06l2.47 2.47V9a.75.75 0 0 1 .75-.75Zm-15 5.25a.75.75 0 0 1 .75-.75h9.75a.75.75 0 0 1 0 1.5H3a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
                </svg>
                Filter
            </h2>

            <div>
                <label for="sort" class="text-sm text-yellow-400 font-medium">Sort by</label>
                <select id="sort" name="sort"
                    class="w-full mt-1 rounded bg-yellow-600/10 text-yellow-50 border border-zinc-700 focus:ring-yellow-500 focus:border-yellow-500 text-sm cursor-pointer">
                    <option value="name" {% if app.request.get('sort') == 'name' %}selected{% endif %}>Name</option>
                    <option value="created" {% if app.request.get('sort') == 'created' %}selected{% endif %}>Recently Added</option>
                </select>
            </div>

            <div>
                <label for="order" class="text-sm text-yellow-400 font-medium">Order</label>
                <select id="order" name="order"
                    class="w-full mt-1 rounded bg-yellow-600/10 text-yellow-50 border border-zinc-700 focus:ring-yellow-500 focus:border-yellow-500 text-sm cursor-pointer">
                    <option value="asc" {% if app.request.get('order') == 'asc' %}selected{% endif %}>Ascending</option>
                    <option value="desc" {% if app.request.get('order') == 'desc' %}selected{% endif %}>Descending</option>
                </select>
            </div>

            <div>
                <label for="albums" class="text-sm text-yellow-400 font-medium">Albums</label>
                <select id="album" name="album"
                    class="w-full mt-1 rounded bg-yellow-600/10 text-yellow-50 border border-zinc-700 focus:ring-yellow-500 focus:border-yellow-500 text-sm cursor-pointer">
                    <option value=""{% if not selectedAlbumId %}selected{% endif %}>All Albums</option>
                        {% for album in albums %}
                            <option value="{{ album.id }}" {% if selectedAlbumId == album.id %}selected{% endif %}>{{ album.title }}</option>
                        {% endfor %}
                </select>
            </div>

            {% if app.user %}
                <div class="flex items-center space-x-2">
                    <input
                        type="checkbox"
                        id="reviews_only"
                        name="my_reviews"
                        value="1"
                        {% if myReviewsFilter %}checked{% endif %}
                        class="rounded border-yellow-500 text-yellow-600 focus:ring-yellow-500 cursor-pointer"
                    />
                    <label for="reviews_only" class="text-yellow-400 text-sm select-none cursor-pointer">My Reviews Only</label>
                </div>
            {% endif %}

            <button type="submit"
                class="mt-1.5 w-full cursor-pointer bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-2.5 px-4 rounded transition text-sm cursor-pointer">
                Apply Filters
            </button>
        </form>
    </aside>

    <!-- Reviews Section -->
    <section class="flex-grow bg-black/70 rounded-xl border border-yellow-500/50 p-4 shadow-xl flex flex-col justify-between min-h-[60vh]">
        <h1 class="text-3xl font-bold text-yellow-50 flex items-center gap-3 mb-6">
            <svg class="w-9 h-9 text-yellow-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 5v14h14V5H5zm2 4h10M7 12h6"/>
            </svg>
            All Reviews
            {% if album %}
                - <span class="text-yellow-400">{{ album.title }}</span>
            {% endif %}
            <span class="ml-auto text-yellow-400 font-mono text-lg select-none" title="Total reviews matching filters">
                {{ totalReviews }} reviews
            </span>
        </h1>

        <div class="flex-grow">
            {% if pagination is not empty %}

                <script type="application/json" id="reviews-json">
                    {{ reviewsData|raw }}
                </script>

                <div
                    x-data="reviewsComponent()"
                    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 justify-items-stretch"
                >
                    {% for rating in pagination %}

                        {% set userScore = rating.ratingScore|default('N/A') %}
                        {% set userScoreColor = 'bg-red-500' %}
                        {% if userScore == 'N/A' %}
                            {% set userScoreColor = 'bg-yellow-50' %}
                        {% elseif userScore >= 75 %}
                            {% set userScoreColor = 'bg-green-500' %}
                        {% elseif userScore >= 50 %}
                            {% set userScoreColor = 'bg-yellow-400' %}
                        {% endif %}

                        <div class="bg-zinc-800/70 backdrop-blur-sm p-4 rounded-xl border border-yellow-300/20 shadow-md w-full relative flex flex-col">
                            <div class="mb-1.5 flex items-center justify-between text-yellow-200 font-semibold text-sm">
                                <span>{{ rating.user.username }}</span>
                                <span class="w-9 h-9 rounded-full flex items-center justify-center font-bold text-black/70 {{ userScoreColor }}">{{ userScore }}</span>
                            </div>

                            <div class="text-m text-yellow-300 mb-3">{{ rating.album.title }}</div>

                            <div class="text-xs text-yellow-100 mb-1.5">{{ rating.createdAt|date('M d, Y') }}</div>

                            <p class="text-sm text-yellow-50 break-words flex-grow">{{ rating.review|slice(0, 300)|trim }}{% if rating.review|length > 300 %}...{% endif %}</p>

                            <div class="mt-3 flex justify-between items-center">
                                {% if rating.review|length > 300 %}
                                    <button
                                        @click="openModal({{ loop.index0 }})"
                                        class="text-yellow-300 hover:text-yellow-200 rounded-xl hover:custom-glow border border-yellow-500/60 text-sm font-semibold focus:outline-none transition cursor-pointer px-3 py-1"
                                    >
                                        Read more
                                    </button>
                                {% else %}
                                    <div></div> {# Empty div to keep flex spacing consistent #}
                                {% endif %}

                                {% if app.user and (app.user.id == rating.user.id or is_granted('ROLE_ADMIN')) %}
                                {% set redirectUrl = url('reviews_list', filters) %}

                                    <button
                                        type="button"
                                        data-album-id="{{ rating.album.id }}"
                                        data-rating-id="{{ rating.id }}"
                                        data-csrf-token="{{ csrf_token('delete-rating-review' ~ rating.id) }}"
                                        class="no-glow delete-review-btn text-red-500 hover:text-red-400 rounded-xl px-3 py-1 cursor-pointer text-sm font-semibold"
                                        title="Delete review" aria-label="Delete Review"
                                        data-redirect-url="{{ redirectUrl }}"
                                    >
                                        <i class="fas fa-trash"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-yellow-100 mt-2">No reviews yet for this album.</p>
            {% endif %}
        </div>

        {% include 'components/modal.html.twig' %}

        {% include 'components/pagination.html.twig' %}

    </section>
</div>
{% endblock %}